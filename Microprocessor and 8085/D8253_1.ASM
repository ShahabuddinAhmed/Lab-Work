;*****************************************
;     MDA-Win8086 EXPERIMENT PROGRAM    *
;     FILENAME  : D8253_1.ASM
;     PROCESSOR : I8086
;     8253 TEST
;*****************************************
CODE	SEGMENT
	ASSUME	CS:CODE,DS:CODE,ES:CODE,SS:CODE
	;
PPIC_C	EQU	1FH
PPIC	EQU	1DH
PPIB	EQU	1BH
PPIA	EQU	19H
	;	
CTC1	EQU	0BH
CTC2	EQU	0DH
CTCC	EQU	0FH
	;
INTA	EQU	10H
INTA2	EQU	INTA+2
	;
INT_V	EQU	41H*4
	;
	ORG	1000H
	;
	XOR	BX,BX
	MOV	ES,BX
	;
	MOV	AX,OFFSET INT_SER
	MOV	BX,INT_V
	MOV	WORD PTR ES:[BX],AX
	;
	XOR	AX,AX
	MOV	WORD PTR ES:[BX+2],AX
	;
	CALL	INIT
	CALL	P_INIT
	;
	MOV	AL,10000000B
	OUT	PPIC_C,AL
	;
	MOV	AL,11111111B
	OUT	PPIA,AL
	;
	MOV	AL,00000000B
	OUT	PPIC,AL
	;
	MOV	AH,11110001B
	MOV	AL,AH
	OUT	PPIB,AL
	STI
L2:	NOP
	JMP	L2		
	;
	INT	3
	;		
	;
INT_SER:
	SHL	AH,1
	TEST	AH,00010000B
	JNZ	L1
	OR	AH,11110000B
	JMP	L3
	; LED out
L1:	MOV	AH,11110001B
L3:	MOV	AL,AH
	OUT	PPIB,AL
	;
	PUSH	AX
	;
	MOV	AX,10
	OUT	CTC2,AL
	MOV	AL,AH
	OUT	CTC2,AL
	;
	;  EOI command
	MOV	AL,00100000B
	OUT	INTA,AL
	POP	AX
	STI
	IRET	
	;
P_INIT  PROC	NEAR
	PUSH	AX
	; timer 1
	MOV	AL,01110110B
	OUT	CTCC,AL
	;timer2
	MOV	AL,10110000B
	OUT	CTCC,AL
	; timer 2
	MOV	AX,10
	OUT	CTC2,AL
	;
	MOV	AL,AH
	OUT	CTC2,AL
	;  timer1
	MOV	AX,0FFFFH
	OUT	CTC1,AL
	MOV	AL,AH
	OUT	CTC1,AL
	;
	POP	AX
	RET	
P_INIT	ENDP
	;
INIT	PROC	NEAR
	; ICW1
 	MOV	AL,00010011B
	OUT	INTA,AL
	;ICW2 interrupt vector
	MOV	AL,40H
	OUT	INTA2,AL
	;ICW4
	MOV	AL,00000001B
	OUT	INTA2,AL
	;interrupt mask
	MOV 	AL,11111101B
	OUT	INTA2,AL
	RET
INIT	ENDP
	;	
CODE	ENDS
	END


